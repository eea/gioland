{% extends "layout.html" %}
{% from 'bits.html' import metadata_table, files_table with context %}
{% from 'bits.html' import breadcrumb_items %}

{% block page_heading %}
  <h1>High Resolution Layers</h1>
{% endblock %}

{% block breadcrumb %}
  {{ breadcrumb_items([
    (url_for('parcel.index'), 'GioLand'),
    (url_for('parcel.view', name=parcel.name),
             THEME_MAP[parcel.metadata["theme"]],)
  ]) }}
{% endblock %}

{% block content %}

<p>
  {% set overview_url = url_for('parcel.chain', name=parcel.name) %}
  <a href="{{ overview_url }}">workflow overview</a>

  {% if authorize_for_parcel(parcel) and config['ALLOW_PARCEL_DELETION'] %}
    <a href="{{ url_for('parcel.delete', name=parcel.name) }}"
       class="delete-parcel">delete</a>
  {% endif %}
</p>

<h2>Metadata</h2>
{% set metadata = parcel.metadata %}
{{ metadata_table(metadata) }}

{% if not STAGES[parcel.metadata['stage']]['last'] %}

<h2>Files</h2>

{% if parcel.uploading and authorize_for_parcel(parcel) %}
  {% set file_authorize = True %}
{% else %}
  {% set file_authorize = False %}
{% endif %}

{{ files_table(parcel.get_path(), parcel=parcel,
               delete_buttons=file_authorize) }}

{% if file_authorize %}
  <form method="post" enctype="multipart/form-data"
        action="{{ url_for('parcel.upload', name=parcel.name) }}">
      <label for="form-upload-file">Add file</label>
      <input id="form-upload-file" type="file" name="file">
      <input type="submit" value="Upload">
    </form>

    <form method="get"
          action="{{ url_for('parcel.finalize', name=parcel.name) }}">
      <p>
        When all files are ready, finalize the parcel, which will trigger
        the next workflow step.
      </p>

      <button type="submit">Finalize</button>

      {% if STAGES[parcel.metadata['stage']]['reject'] %}
        <button type="submit" name="reject" value="on">
          Finalize and reject</button>
      {% endif %}

    </form>
{% endif %}

{% endif %}


<h2>History</h2>

<ul class="history-list">
{% for item in parcel.history %}

  <li class="history-item">
    <h3>{{ item.title }} on
        {{ item.time|date("%d/%m/%Y %H:%M") }}
        by {{ item.actor }}</h3>
    <div class="history-item-description">
      {{ item.description_html|safe }}
    </div>
  </li>

{% endfor %}
</ul>

{% if g.username %}
  <form method="post" action="{{ url_for('parcel.comment', name=parcel.name) }}"
  <strong>Comment</strong>
  <textarea name="comment" class="comment"></textarea>
  <button>Add comment</button>
{% endif %}

{% endblock %}
