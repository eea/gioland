{% extends "layout.html" %}


{% from 'bits.html' import breadcrumb_items %}
{% block breadcrumb %}
  {{ breadcrumb_items([
    (url_for('parcel.index'), 'GIO Land'),
    (url_for('parcel.view', name=first_parcel.name),
             PRODUCT_MAP[first_parcel.metadata["product"]]),
    (url_for('parcel.chain', name=first_parcel.name),
             "High Resolution Layers - workflow overview")
  ]) }}
{% endblock %}


{% block page_heading %}
  <h1>High Resolution Layers &mdash; workflow overview</h1>
{% endblock %}

{% block content %}

  {% from 'bits.html' import metadata_table with context %}
  {% set metadata = first_parcel.metadata %}
  {{ metadata_table(metadata, show_stage=False) }}


  {% if prev_parcels %}

  <table id="parcels-merged-history" class="datatable" style="width: 290px;">

    <thead>
      <tr>
        <th colspan="2">
          Merged with {{ prev_parcels|count }} other parcels</th>
      </tr>
      <tr>
        <th>Stage</th>
        <th>Time</th>
      </tr>
    </thead>

    <tbody>
      {% for prev_parcel in prev_parcels %}
        <tr>
          <td>
            {% set prev_parcel_url = url_for('parcel.view',
                                             name=prev_parcel.name) %}
            {% if prev_parcel.metadata['delivery_type']  == COUNTRY %}
              {% set DELIVERY_STAGE_MAP = STAGE_MAP %}
            {% elif prev_parcel.metadata['delivery_type'] == LOT %}
              {% if prev_parcel.metadata['extent'] == 'partial' %}
                {% set DELIVERY_STAGE_MAP = PARTIAL_LOT_STAGE_MAP %}
              {% else %}
                {% set DELIVERY_STAGE_MAP = FULL_LOT_STAGE_MAP %}
              {% endif %}
            {% else %}
              {% set DELIVERY_STAGE_MAP = STREAM_STAGE_MAP %}
            {% endif %}
            {% set stage = DELIVERY_STAGE_MAP[prev_parcel.metadata['stage']]  %}
            <a href="{{ prev_parcel_url }}">
              {{ stage  }} </a>
          </td>
          <td>
            {{ prev_parcel.metadata['upload_time']|isoformat_to_datetime
                                                  |datetime }}
          </td>
        </tr>
      {% endfor %}
    </tbody>

  </table>

  {% endif %}

  <table class="datatable" style="width: 290px;">

    <thead>
      <th>Stage</th>
      <th>Time</th>
    </thead>

    <tbody>

    {% for parcel in workflow_parcels %}
      <tr>

        <td>
          {% set parcel_url = url_for('parcel.view', name=parcel.name) %}
          {% set DELIVERY_STAGES, _ = get_stages_for_parcel(parcel) %}
          {% if parcel.metadata['delivery_type']  == COUNTRY %}
            {% set DELIVERY_STAGE_MAP = STAGE_MAP %}
          {% elif parcel.metadata['delivery_type'] == LOT %}
            {% if parcel.metadata['extent'] == 'partial' %}
              {% set DELIVERY_STAGE_MAP = PARTIAL_LOT_STAGE_MAP %}
            {% else %}
              {% set DELIVERY_STAGE_MAP = FULL_LOT_STAGE_MAP %}
            {% endif %}
          {% else %}
              {% set DELIVERY_STAGE_MAP = STREAM_STAGE_MAP %}
          {% endif %}
          {% set stage = DELIVERY_STAGE_MAP[parcel.metadata['stage']]  %}
          <a href="{{ parcel_url }}">
            {{ stage }}
            {% if parcel.metadata.get('merged') %}(merged){% endif %}
          </a>
        </td>

        <td>
          {% if parcel.uploading %}

            {% if DELIVERY_STAGES[parcel.metadata['stage']]['last'] %}
              <em>done</em>
            {% else %}
              <em>in progress</em>
            {% endif %}

          {% else %}
            {{ parcel.metadata['upload_time']|isoformat_to_datetime|datetime }}
          {% endif %}
        </td>

      </tr>
    {% endfor %}

    </tbody>
  </table>

{% endblock %}
